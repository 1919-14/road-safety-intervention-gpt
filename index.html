<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Safety GPT - Indian Road Safety Intervention</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
         :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            /* Background color tokens (Light Mode) */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);
            /* Road Safety Custom Colors */
            --color-road-navy: #1a365d;
            --color-saffron: #ff9933;
            --color-india-green: #138808;
            --color-safety-orange: #ff6b35;
            --color-safety-red: #dc2626;
            /* Semantic Color Tokens (Light Mode) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;
            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @font-face {
            font-family: 'FKGroteskNeue';
            src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        /* Sidebar Styles */
        
        .sidebar {
            width: 240px;
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            padding: var(--space-16);
        }
        
        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-12);
            margin-bottom: var(--space-24);
        }
        
        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--color-road-navy), var(--color-safety-orange));
            border-radius: var(--radius-base);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .brand-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }
        
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: var(--space-24);
        }
        
        .nav-section-header {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 var(--space-12);
            margin-bottom: var(--space-8);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            color: var(--color-text);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            font-size: var(--font-size-base);
            margin-bottom: var(--space-4);
        }
        
        .nav-item:hover {
            background-color: var(--color-secondary);
        }
        
        .nav-item.active {
            background-color: rgba(255, 153, 51, 0.1);
            color: var(--color-road-navy);
            font-weight: var(--font-weight-medium);
            border-left: 3px solid var(--color-saffron);
            padding-left: 9px;
        }
        
        .nav-item i {
            width: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-top: var(--space-16);
        }
        
        .user-profile:hover {
            background-color: var(--color-secondary);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }
        
        .user-role {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }
        
        .user-menu-icon {
            color: var(--color-text-secondary);
            font-size: 16px;
        }
        /* Main Content Styles */
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-16) var(--space-24);
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-surface);
        }
        
        .model-selector {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            background-color: var(--color-background);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }
        
        .model-tagline {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-left: var(--space-4);
        }
        
        .model-selector:hover {
            background-color: var(--color-secondary);
        }
        
        .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-24);
            overflow-y: auto;
        }
        
        .input-area {
            border-top: 1px solid var(--color-border);
            background-color: var(--color-surface);
            padding: var(--space-16) var(--space-24);
        }
        
        .greeting {
            text-align: center;
            margin: auto;
            max-width: 720px;
        }
        
        .greeting.hidden {
            display: none;
        }
        
        .greeting h1 {
            font-size: 48px;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-32);
            letter-spacing: var(--letter-spacing-tight);
        }
        
        .input-container {
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
        }
        
        .message-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-12) var(--space-16);
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .message-input-wrapper:focus-within {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }
        
        .input-icons-left {
            display: flex;
            gap: var(--space-12);
            margin-right: var(--space-12);
        }
        
        .input-icon {
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 18px;
            transition: color var(--duration-fast) var(--ease-standard);
        }
        
        .input-icon:hover {
            color: var(--color-text);
        }
        
        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: var(--font-size-lg);
            color: var(--color-text);
            font-family: var(--font-family-base);
        }
        
        .message-input::placeholder {
            color: var(--color-text-secondary);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background-color: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-left: var(--space-12);
        }
        
        .send-button:hover {
            background-color: var(--color-primary-hover);
            transform: scale(1.05);
        }
        
        .send-button:active {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background-color: var(--color-text-secondary);
            cursor: not-allowed;
            transform: scale(1);
        }
        
        .new-chat-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            padding: var(--space-12);
            margin-bottom: var(--space-20);
            border-radius: var(--radius-base);
            background-color: var(--color-saffron);
            color: white;
            border: none;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .new-chat-btn:hover {
            background-color: #ff8800;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .chat-history-item {
            padding: var(--space-12);
            margin-bottom: var(--space-4);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .chat-history-item:hover {
            background-color: var(--color-secondary);
        }
        
        .chat-history-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            margin-bottom: var(--space-4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-history-date {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }
        
        .chat-messages {
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            display: none;
            flex-direction: column;
            gap: var(--space-16);
        }
        
        .chat-messages.active {
            display: flex;
        }
        
        .message {
            display: flex;
            gap: var(--space-12);
            animation: messageSlideIn 0.3s var(--ease-standard);
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .message-content strong {
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }
        
        .message.user .message-content {
            background-color: var(--color-bg-1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: var(--color-text);
        }
        
        .message.bot .message-content {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        
        .message-time {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }
        
        .message.user .message-time {
            text-align: right;
        }
        
        .typing-indicator {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-12) var(--space-16);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--color-text-secondary);
            animation: typingBounce 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingBounce {
            0%,
            60%,
            100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }
        
        .disclaimer {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-align: center;
            margin-top: var(--space-12);
        }
        
        .error-message {
            background-color: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: var(--color-error);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-12);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            gap: var(--space-8);
            z-index: 1000;
        }
        
        .connection-status.connected {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--color-success);
        }
        
        .connection-status.disconnected {
            background-color: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: var(--color-error);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: statusPulse 2s infinite;
        }
        
        .connection-status.connected .status-dot {
            background-color: var(--color-success);
        }
        
        .connection-status.disconnected .status-dot {
            background-color: var(--color-error);
        }
        
        @keyframes statusPulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* Responsive Design */
        
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .greeting h1 {
                font-size: 36px;
            }
            .message-content {
                max-width: 85%;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                position: absolute;
                left: -240px;
                z-index: 1000;
                transition: left var(--duration-normal) var(--ease-standard);
            }
            .sidebar.open {
                left: 0;
            }
            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="brand-icon">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <span class="brand-name">Road Safety GPT</span>
            </div>

            <button class="new-chat-btn">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-header">Main</div>
                    <div class="nav-item active" data-page="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </div>
                    <div class="nav-item" data-page="settings">
                        <i class="fas fa-gear"></i>
                        <span>Settings</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-header">Chat History</div>
                    <div class="chat-history-item" data-chat-id="1">
                        <div class="chat-history-title">Speed Limit Query</div>
                        <div class="chat-history-date">Today</div>
                    </div>
                    <div class="chat-history-item" data-chat-id="2">
                        <div class="chat-history-title">Accident Response Protocol</div>
                        <div class="chat-history-date">Yesterday</div>
                    </div>
                    <div class="chat-history-item" data-chat-id="3">
                        <div class="chat-history-title">Vehicle Documentation Rules</div>
                        <div class="chat-history-date">Nov 12</div>
                    </div>
                    <div class="chat-history-item" data-chat-id="4">
                        <div class="chat-history-title">Night Driving Safety Tips</div>
                        <div class="chat-history-date">Nov 11</div>
                    </div>
                    <div class="chat-history-item" data-chat-id="5">
                        <div class="chat-history-title">License Renewal Process</div>
                        <div class="chat-history-date">Nov 10</div>
                    </div>
                    <div class="chat-history-item" data-chat-id="6">
                        <div class="chat-history-title">Parking Violations Fine</div>
                        <div class="chat-history-date">Nov 9</div>
                    </div>
                </div>
            </nav>

            <div class="user-profile">
                <div class="user-avatar">RS</div>
                <div class="user-info">
                    <div class="user-name">IRC</div>
                    <div class="user-role">Road Safety Authority</div>
                </div>
                <i class="fas fa-ellipsis-vertical user-menu-icon"></i>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="model-selector">
                    <span>Road Safety GPT v1.0</span>
                    <span class="model-tagline">Powered by IRC</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="header-avatar">RS</div>
            </header>

            <div class="content-area">
                <div class="greeting" id="greeting">
                    <h1>How can I help you with road safety?</h1>
                </div>

                <div class="chat-messages" id="chatMessages"></div>
            </div>

            <div class="input-area">
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div class="input-container">
                    <div class="message-input-wrapper">
                        <div class="input-icons-left">
                            <i class="fas fa-paperclip input-icon"></i>
                        </div>
                        <input type="text" class="message-input" id="messageInput" placeholder="Ask about traffic rules, violations, safety tips..." />
                        <button class="send-button" id="sendButton">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
                <p class="disclaimer">Road Safety GPT provides information based on Indian traffic laws. Always verify with official authorities for critical matters.</p>
            </div>
        </main>
    </div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <div class="status-dot"></div>
        <span id="statusText">Connecting to backend...</span>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_BASE_URL = 'http://localhost:5000';
        const API_CHAT_ENDPOINT = '/api/chat';
        const API_HEALTH_ENDPOINT = '/api/health';

        // ==================== STATE MANAGEMENT ====================
        let currentChat = [];
        let isWaitingForResponse = false;
        let backendConnected = false;
        let chatHistories = {
            1: [{
                role: 'user',
                content: 'What are the speed limits on Indian highways?',
                time: '3:45 PM'
            }, {
                role: 'bot',
                content: 'According to Indian traffic regulations:\n\n**National Highways**: 100-120 km/h (cars)\n**State Highways**: 80 km/h\n**Urban roads**: 40-50 km/h\n\nSpeed limits may vary based on road conditions and vehicle type. Always follow signboard instructions.',
                time: '3:46 PM'
            }],
            2: [{
                role: 'user',
                content: 'How should I handle an accident?',
                time: '2:30 PM'
            }, {
                role: 'bot',
                content: 'In case of an accident:\n\n1. Stop immediately and check for injuries\n2. Call **emergency services** (100 for police, 102 for ambulance)\n3. Move vehicles to safe location if possible\n4. Exchange information with other party\n5. Take photos of the scene and vehicle damage\n6. File **FIR** if needed\n7. Notify your insurance company\n\nDo not leave the accident scene before authorities arrive.',
                time: '2:31 PM'
            }],
            3: [{
                role: 'user',
                content: 'What documents are required for driving?',
                time: '11:20 AM'
            }, {
                role: 'bot',
                content: '**Essential documents** required while driving in India:\n\n• **Valid Driving License**\n• **Vehicle Registration Certificate (RC)**\n• **Insurance Certificate**\n• **Pollution Under Control (PUC) Certificate**\n• **Fitness Certificate** (for commercial vehicles)\n\nKeep all documents readily available during driving. Digital copies in DigiLocker are also valid.',
                time: '11:21 AM'
            }],
            4: [{
                role: 'user',
                content: 'What are safety tips for night driving?',
                time: '9:15 PM'
            }, {
                role: 'bot',
                content: '**Night driving safety tips**:\n\n• Ensure **headlights** are working properly\n• Use high beams on highways (dim for oncoming traffic)\n• Reduce speed and increase following distance\n• Stay alert and take breaks on long journeys\n• Avoid looking directly at oncoming headlights\n• Keep windshield clean\n• Watch for pedestrians and animals\n\nNever drink and drive. If tired, take a rest break.',
                time: '9:16 PM'
            }],
            5: [{
                role: 'user',
                content: 'How do I renew my driving license?',
                time: '4:40 PM'
            }, {
                role: 'bot',
                content: 'To **renew your driving license** in India:\n\n1. Visit your nearest **RTO office**\n2. Submit **Form 7** (for renewal) or **Form 8** (for address change)\n3. Pay the required fee\n4. Appear for eye and medical test if needed\n5. Your license will be valid for **5-10 years** depending on age\n\nOnline renewal is available in some states. Check your state\'s RTO website.',
                time: '4:41 PM'
            }],
            6: [{
                role: 'user',
                content: 'What is the fine for parking violations?',
                time: '1:25 PM'
            }, {
                role: 'bot',
                content: '**Parking violation fines** in India:\n\n• **Unauthorized parking**: ₹500\n• **Parking in no-parking zone**: ₹500-1,000\n• **Obstructing traffic**: ₹500-1,000\n• **Parking on footpath**: ₹500\n\nFines may vary by state and city. Repeated violations can lead to vehicle towing and additional charges.',
                time: '1:26 PM'
            }]
        };

        // ==================== DOM ELEMENTS ====================
        const greeting = document.getElementById('greeting');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const newChatBtn = document.querySelector('.new-chat-btn');
        const chatHistoryItems = document.querySelectorAll('.chat-history-item');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            messageInput.focus();
            checkBackendConnection();
            setupEventListeners();
        });

        // ==================== MARKDOWN PARSING ====================
        function parseMarkdown(content) {
            // First, split into lines to process lists and bold separately
            const lines = content.split('\n');
            let isInList = false;
            let listItems = [];
            let parsedLines = [];

            for (let line of lines) {
                // Check if line starts with "* " (bullet)
                if (line.trim().startsWith('* ')) {
                    // Extract content after "* "
                    let bulletContent = line.substring(2).trim();

                    // Apply bold parsing to bullet content
                    bulletContent = bulletContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                    listItems.push(`<li>${bulletContent}</li>`);
                    isInList = true;
                } else {
                    // Not a bullet line - process as regular content
                    let normalContent = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                    // If we were in a list, close it and add the items
                    if (isInList) {
                        if (listItems.length > 0) {
                            parsedLines.push(`<ul>${listItems.join('')}</ul>`);
                        }
                        listItems = [];
                        isInList = false;
                    }

                    // Add non-list line (escape <br> if needed, but since we're building HTML, add as is)
                    if (normalContent.trim()) {
                        parsedLines.push(normalContent);
                    }
                }
            }

            // Close any open list at the end
            if (isInList && listItems.length > 0) {
                parsedLines.push(`<ul>${listItems.join('')}</ul>`);
            }

            // Join parsed lines with <br> for line breaks
            let parsed = parsedLines.join('<br>');

            // Final bold pass on any remaining content (in case of inline after lists)
            parsed = parsed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            return parsed;
        }

        // ==================== BACKEND CONNECTION CHECK ====================
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}${API_HEALTH_ENDPOINT}`);
                if (response.ok) {
                    const data = await response.json();
                    backendConnected = true;
                    updateConnectionStatus(true);
                    console.log('✓ Backend connected:', data);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Backend connection failed:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(isConnected) {
            if (isConnected) {
                connectionStatus.classList.remove('disconnected');
                connectionStatus.classList.add('connected');
                statusText.textContent = '✓ Backend Connected';
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.classList.add('disconnected');
                statusText.textContent = '✗ Backend Offline - Using local responses';
            }
        }

        // ==================== EVENT SETUP ====================
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            newChatBtn.addEventListener('click', startNewChat);
            chatHistoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    const chatId = this.getAttribute('data-chat-id');
                    loadChatHistory(parseInt(chatId));
                });
            });

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getTimeString() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const minutesStr = minutes < 10 ? '0' + minutes : minutes;
            return hours + ':' + minutesStr + ' ' + ampm;
        }

        function addMessage(role, content, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // Parse markdown and set innerHTML for formatting
            const formattedContent = parseMarkdown(content);
            messageContent.innerHTML = formattedContent;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = time || getTimeString();

            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            currentChat.push({
                role,
                content,
                time: time || getTimeString()
            });
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            typingDiv.appendChild(indicator);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // ==================== SEND MESSAGE ====================
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isWaitingForResponse) return;

            // Hide greeting, show chat
            greeting.classList.add('hidden');
            chatMessages.classList.add('active');

            // Add user message
            addMessage('user', message);
            messageInput.value = '';

            // Show typing indicator
            showTypingIndicator();
            isWaitingForResponse = true;
            sendButton.disabled = true;

            try {
                if (backendConnected) {
                    // Try to get response from backend
                    const response = await fetch(`${API_BASE_URL}${API_CHAT_ENDPOINT}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    removeTypingIndicator();
                    addMessage('bot', data.response); // Will be parsed for bold
                    console.log('Backend response received');

                } else {
                    // Fallback to local responses
                    throw new Error('Backend not connected');
                }

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();

                // Check backend connection and try again, or use local response
                try {
                    await checkBackendConnection();
                    if (backendConnected) {
                        const response = await fetch(`${API_BASE_URL}${API_CHAT_ENDPOINT}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: message
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            addMessage('bot', data.response);
                            console.log('Backend response received (retry)');
                        } else {
                            showLocalResponse(message);
                        }
                    } else {
                        showLocalResponse(message);
                    }
                } catch (retryError) {
                    console.error('Retry failed:', retryError);
                    showLocalResponse(message);
                }
            } finally {
                isWaitingForResponse = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        function showLocalResponse(userMessage) {
            const localResponse = getBotResponse(userMessage);
            addMessage('bot', localResponse); // Will be parsed for bold
            showErrorMessage('Using local response (backend offline). For best results, ensure the backend server is running.');
        }

        function getBotResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            const sampleResponses = {
                'speed': 'According to Indian traffic regulations:\n\n**National Highways**: 100-120 km/h (cars)\n**State Highways**: 80 km/h\n**Urban roads**: 40-50 km/h\n\nSpeed limits may vary based on road conditions and vehicle type. Always follow signboard instructions.',
                'fine': 'The **fine structure** depends on the violation. Common violations include:\n\n• **Speeding**: ₹500-2,000\n• **No helmet**: ₹1,000 + license suspension\n• **No seatbelt**: ₹1,000\n• **Drunk driving**: ₹10,000 + imprisonment\n• **Signal jumping**: ₹1,000\n\nCan you specify which violation you\'re asking about?',
                'accident': 'In case of an **accident**:\n\n1. Stop immediately and check for injuries\n2. Call **emergency services** (100 for police, 102 for ambulance)\n3. Move vehicles to safe location if possible\n4. Exchange information with other party\n5. Take photos of the scene and vehicle damage\n6. File **FIR** if needed\n7. Notify your insurance company\n\nDo not leave the accident scene before authorities arrive.',
                'license': 'To **renew your driving license** in India:\n\n1. Visit your nearest **RTO office**\n2. Submit **Form 7** (for renewal) or **Form 8** (for address change)\n3. Pay the required fee\n4. Appear for eye and medical test if needed\n5. Your license will be valid for **5-10 years** depending on age\n\nOnline renewal is available in some states. Check your state\'s RTO website.',
                'document': '**Essential documents** required while driving in India:\n\n• **Valid Driving License**\n• **Vehicle Registration Certificate (RC)**\n• **Insurance Certificate**\n• **Pollution Under Control (PUC) Certificate**\n• **Fitness Certificate** (for commercial vehicles)\n\nKeep all documents readily available during driving.',
                'default': 'I\'m **Road Safety GPT**, here to help with:\n\n• Traffic rules and regulations\n• Violation fines and penalties\n• Accident procedures\n• License and documentation\n• Safety tips and guidelines\n\nPlease ask me about any road safety topic!'
            };

            for (const [key, response] of Object.entries(sampleResponses)) {
                if (key !== 'default' && lowerMessage.includes(key)) {
                    return response;
                }
            }

            return sampleResponses.default;
        }

        // ==================== NEW CHAT ====================
        function startNewChat() {
            currentChat = [];
            chatMessages.innerHTML = '';
            chatMessages.classList.remove('active');
            greeting.classList.remove('hidden');
            messageInput.value = '';
            messageInput.focus();
        }

        // ==================== LOAD CHAT HISTORY ====================
        function loadChatHistory(chatId) {
            const history = chatHistories[chatId];
            if (!history) return;

            currentChat = [];
            chatMessages.innerHTML = '';
            greeting.classList.add('hidden');
            chatMessages.classList.add('active');

            history.forEach(msg => {
                addMessage(msg.role, msg.content, msg.time); // Parses markdown
            });
        }

        // Periodically check backend connection
        setInterval(checkBackendConnection, 30000);
    </script>
</body>

</html>